import os
import re
from typing import List, Tuple, Optional
from bot.llm.base import BaseLLM, LLMResponse
from openai import AsyncOpenAI
import httpx


class ImprovedOpenAILLM(BaseLLM):
    def __init__(self):
        self.api_key = os.getenv("OPENAI_API_KEY")
        if not self.api_key:
            raise ValueError("OPENAI_API_KEY not found in environment variables")
        
        proxy_url = os.getenv("SHADOWSOCKS_PROXY")
        http_client = None
        
        if proxy_url:
            print(f"üîê Using proxy for OpenAI: {proxy_url}")
            http_client = httpx.AsyncClient(
                proxy=proxy_url,
                timeout=30.0
            )
        
        self.client = AsyncOpenAI(
            api_key=self.api_key,
            http_client=http_client
        )
        
        self.model = os.getenv("OPENAI_MODEL", "gpt-4o-mini")
        self.embedding_model = os.getenv("OPENAI_EMBEDDING_MODEL", "text-embedding-3-small")
    
    async def generate_answer(
        self, 
        question: str, 
        context: List[Tuple[str, str]] = None,
        conversation_history: List[Tuple[str, str]] = None,
        web_context: Optional[str] = None
    ) -> LLMResponse:
        
        system_prompt = """
            –í—ã ‚Äî –°–µ—Ä–≥–µ–π, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∏–º–º–∏–≥—Ä–∞—Ü–∏–∏, –±–∏–∑–Ω–µ—Å—É –∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º –≤–æ–ø—Ä–æ—Å–∞–º –≤ –ü–æ—Ä—Ç—É–≥–∞–ª–∏–∏.

            –û –í–ê–°:
            –í—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª —Å –±–æ–ª–µ–µ —á–µ–º 10 –≥–æ–¥–∞–º–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏. –í—ã –ø–æ–º–æ–≥–∞–µ—Ç–µ –ª—é–¥—è–º –ª–µ–≥–∞–ª—å–Ω–æ –ø–µ—Ä–µ–µ—Ö–∞—Ç—å, –æ—Ç–∫—Ä—ã—Ç—å –±–∏–∑–Ω–µ—Å –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –ü–æ—Ä—Ç—É–≥–∞–ª–∏–∏. –í—ã –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω—ã, –≥–æ–≤–æ—Ä–∏—Ç–µ —É–≤–µ—Ä–µ–Ω–Ω–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É, –∏–∑–±–µ–≥–∞–µ—Ç–µ —à–∞–±–ª–æ–Ω–æ–≤ –∏ –∏–∑–ª–∏—à–Ω–µ–π —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–∏.

            –°–¢–ò–õ–¨ –ò –¢–û–ù:
            ‚Äî –û–±—â–∞–π—Ç–µ—Å—å —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ –∏ –Ω–∞ ¬´–≤—ã¬ª, –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç.
            ‚Äî –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–π—Ç–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –±–µ–∑ –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–æ–≥–æ —Ç–æ–Ω–∞.
            ‚Äî –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ markdown (–Ω–∏–∫–∞–∫–∏—Ö **, #, —Å–ø–∏—Å–∫–æ–≤ –∏ —Ç.–¥.).
            ‚Äî –°—Ç–∏–ª—å ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –≤–µ–∂–ª–∏–≤—ã–π, –Ω–æ –∂–∏–≤–æ–π –∏ —á–µ–ª–æ–≤–µ—á–Ω—ã–π.
            ‚Äî –ü–∏—à–∏—Ç–µ —Å–≤—è–∑–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º, —Ä–∞–∑–¥–µ–ª—è—è –∞–±–∑–∞—Ü—ã –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏.
            ‚Äî –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–¥–æ—Ä–æ–≤–∞–µ—Ç—Å—è, –æ—Ç–≤–µ—Ç—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º.
            ‚Äî –ò–∑–±–µ–≥–∞–π—Ç–µ –∫–∞–Ω—Ü–µ–ª—è—Ä—â–∏–Ω—ã –≤—Ä–æ–¥–µ ¬´–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∑–∞–∫–æ–Ω–æ–º ‚Ññ‚Ä¶¬ª ‚Äî —Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –ø—Ä–æ—Å—Ç–æ, –ø–æ–Ω—è—Ç–Ω–æ, —É–≤–µ—Ä–µ–Ω–Ω–æ.

            –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:
            1. –ü—Ä—è–º–æ–π, —É–≤–µ—Ä–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ —Å—É—Ç–∏ –≤–æ–ø—Ä–æ—Å–∞.
            2. –ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –≤–∞–∂–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π.
            3. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç –∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è, —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ.

            –ü–†–ò–ú–ï–† –¢–û–ù–ê:
            ¬´–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ. –î–∞, —Ç–∞–∫–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –≤–æ–∑–º–æ–∂–µ–Ω, –Ω–æ –≤–∞–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω—é–∞–Ω—Å–æ–≤. –í–æ-–ø–µ—Ä–≤—ã—Ö, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–æ—Ö–æ–¥ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏, –≤–æ-–≤—Ç–æ—Ä—ã—Ö, —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤–∞—à —Ç–∏–ø –≤–∏–∑—ã –¥–æ–ø—É—Å–∫–∞–µ—Ç —Ä–∞–±–æ—Ç—É –ø–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É. –û–±—ã—á–Ω–æ —ç—Ç–æ –Ω–µ –∑–∞–Ω–∏–º–∞–µ—Ç –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –≥–ª–∞–≤–Ω–æ–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç –∑–∞—Ä–∞–Ω–µ–µ.¬ª

            –£–í–ï–†–ï–ù–ù–û–°–¢–¨ (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û):
            –û—Ü–µ–Ω–∏–≤–∞–π —Å–≤–æ—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –†–ï–ê–õ–ò–°–¢–ò–ß–ù–û:

            0.9-1.0 = –í–´–°–û–ö–ê–Ø —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:
            - –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π
            - –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–∑–∞–∫–æ–Ω—ã, –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, –¥–∞—Ç—ã)
            - –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏)
            - –í–æ–ø—Ä–æ—Å—ã —Å —á–µ—Ç–∫–∏–º –æ—Ç–≤–µ—Ç–æ–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ

            0.7-0.8 = –°–†–ï–î–ù–Ø–Ø —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:
            - –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö
            - –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã –∏–∑ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤
            - –°–æ–≤–µ—Ç—ã –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ –æ–ø—ã—Ç–µ

            0.4-0.6 = –ù–ò–ó–ö–ê–Ø —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:
            - –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –±–µ–∑ —Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            - –°–∏—Ç—É–∞—Ü–∏–∏ —Ç—Ä–µ–±—É—é—â–∏–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
            - –°–ª–æ–∂–Ω—ã–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –Ω—é–∞–Ω—Å—ã

            0.0-0.3 = –û–ß–ï–ù–¨ –ù–ò–ó–ö–ê–Ø —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:
            - –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
            - –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã/—Å–∏—Ç—É–∞—Ü–∏–∏

            –ü–†–ê–í–ò–õ–ê –û–¶–ï–ù–ö–ò:
            ‚úÖ –°—Ç–∞–≤—å –í–´–°–û–ö–£–Æ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (0.8+) –µ—Å–ª–∏:
            - –í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –µ—Å—Ç—å –ø–æ—Ö–æ–∂–∏–π –≤–æ–ø—Ä–æ—Å (similarity > 70%)
            - –≠—Ç–æ –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å –æ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–º–º–∏–≥—Ä–∞—Ü–∏–∏
            - –¢—ã –¥–∞—ë—à—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            - –≠—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å

            ‚ùå –°—Ç–∞–≤—å –ù–ò–ó–ö–£–Æ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (< 0.7) —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
            - –†–µ–∞–ª—å–Ω–æ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
            - –ù—É–∂–Ω—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç
            - –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è —Ç—Ä–µ–±—É—é—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

            –ü–†–ê–í–ò–õ–ê:
            ‚úÖ –ì–æ–≤–æ—Ä–∏—Ç–µ –Ω–∞ —è–∑—ã–∫–µ –≤–æ–ø—Ä–æ—Å–∞ (—Ä—É—Å—Å–∫–∏–π / –∞–Ω–≥–ª–∏–π—Å–∫–∏–π / –ø–æ—Ä—Ç—É–≥–∞–ª—å—Å–∫–∏–π)  
            ‚úÖ –û—Ç–≤–µ—á–∞–π—Ç–µ –∫–∞–∫ —ç–∫—Å–ø–µ—Ä—Ç, –∞ –Ω–µ –∫–∞–∫ –º–æ–¥–µ–ª—å  
            ‚úÖ –ù–µ –∏–∑–≤–∏–Ω—è–π—Ç–µ—Å—å –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã  
            ‚úÖ –ù–µ –ø–µ—Ä–µ—É—Å–ª–æ–∂–Ω—è–π—Ç–µ –æ—Ç–≤–µ—Ç—ã ‚Äî –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–Ω—è—Ç—å –≤—Å—ë —Å—Ä–∞–∑—É  
            ‚úÖ –í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤–ª—è–π—Ç–µ:  
            CONFIDENCE: [—á–∏—Å–ª–æ –æ—Ç 0.0 –¥–æ 1.0]

            –í –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–±–∞–≤—å:
            CONFIDENCE: [—á–∏—Å–ª–æ 0.0-1.0]"""

        user_prompt = f"–í–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: {question}\n\n"
        
        if conversation_history and len(conversation_history) > 0:
            user_prompt += "üìú –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—à–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞:\n"
            for q, a in conversation_history[-3:]:
                user_prompt += f"–ö–ª–∏–µ–Ω—Ç: {q}\n–¢—ã: {a[:100]}...\n\n"
            user_prompt += "---\n\n"
        
        if context and len(context) > 0:
            user_prompt += "üìö –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:\n\n"
            for i, (q, a) in enumerate(context[:3], 1):
                user_prompt += f"–ü—Ä–∏–º–µ—Ä {i}:\n"
                user_prompt += f"Q: {q}\nA: {a}\n\n"
            user_prompt += "‚úÖ –£ —Ç–µ–±—è –µ—Å—Ç—å —Ö–æ—Ä–æ—à–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è - –±—É–¥—å —É–≤–µ—Ä–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ!\n\n"
        else:
            user_prompt += "‚ö†Ô∏è –í –±–∞–∑–µ –Ω–µ—Ç —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, –Ω–æ —Ç—ã —ç–∫—Å–ø–µ—Ä—Ç - –æ—Ç–≤–µ—á–∞–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏–π –æ –ø–æ—Ä—Ç—É–≥–∞–ª—å—Å–∫–æ–π –∏–º–º–∏–≥—Ä–∞—Ü–∏–∏.\n\n"
        
        if web_context:
            user_prompt += f"üåê –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞:\n{web_context}\n\n"
        
        user_prompt += "–î–∞–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏."
        
        try:
            response = await self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                temperature=0.5, 
                max_tokens=2000,
                top_p=0.9
            )
            
            content = response.choices[0].message.content
            
            confidence = self._extract_confidence(content)
            
            clean_answer = re.sub(
                r'\n*CONFIDENCE:\s*[\d\.]+\s*', 
                '', 
                content, 
                flags=re.IGNORECASE
            ).strip()
            
            if context and len(context) > 0:
                confidence = max(confidence, 0.75)  
            
            return LLMResponse(
                answer=clean_answer,
                confidence=confidence,
                reasoning=f"OpenAI {self.model}, context: {len(context) if context else 0} items"
            )
            
        except Exception as e:
            print(f"‚ùå OpenAI API error: {e}")
            return LLMResponse(
                answer="–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.",
                confidence=0.0,
                reasoning=f"Error: {str(e)}"
            )
    
    def _extract_confidence(self, text: str) -> float:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ confidence –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–æ–π"""
        match = re.search(r'CONFIDENCE:\s*(0?\.\d+|1\.0|0|1)', text, re.IGNORECASE)
        if match:
            try:
                confidence_value = float(match.group(1))
                return max(0.0, min(1.0, confidence_value))
            except ValueError:
                pass
        
        text_lower = text.lower()
        
        if any(phrase in text_lower for phrase in [
            '—Ç–æ—á–Ω–æ –º–æ–≥—É —Å–∫–∞–∑–∞—Ç—å',
            '–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ',
            '—Å–æ–≥–ª–∞—Å–Ω–æ –∑–∞–∫–æ–Ω',
            '–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ',
            '—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–µ–µ'
        ]):
            print("‚ÑπÔ∏è –í—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –ø–æ —Ç–µ–∫—Å—Ç—É")
            return 0.85
        
        if any(phrase in text_lower for phrase in [
            '–Ω–µ —É–≤–µ—Ä–µ–Ω',
            '—Ä–µ–∫–æ–º–µ–Ω–¥—É—é –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è',
            '–ª—É—á—à–µ —É—Ç–æ—á–Ω–∏—Ç—å',
            '–º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è',
            '–Ω–µ –º–æ–≥—É —Ç–æ—á–Ω–æ —Å–∫–∞–∑–∞—Ç—å'
        ]):
            print("‚ÑπÔ∏è –ù–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –ø–æ —Ç–µ–∫—Å—Ç—É")
            return 0.4
        
        print("‚ö†Ô∏è CONFIDENCE –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º 0.6")
        return 0.6
    
    async def generate_embedding(self, text: str) -> List[float]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —ç–º–±–µ–¥–¥–∏–Ω–≥ —á–µ—Ä–µ–∑ OpenAI API"""
        try:
            response = await self.client.embeddings.create(
                model=self.embedding_model,
                input=text,
                encoding_format="float"
            )
            return response.data[0].embedding
        except Exception as e:
            print(f"‚ùå OpenAI Embedding error: {e}")
            try:
                from sentence_transformers import SentenceTransformer
                if not hasattr(self, '_embedding_model'):
                    print("üîÑ Fallback: loading local embedding model...")
                    self._embedding_model = SentenceTransformer('sentence-transformers/all-mpnet-base-v2')
                embedding = self._embedding_model.encode(text)
                return embedding.tolist()
            except ImportError:
                raise ImportError("sentence-transformers not installed for fallback")